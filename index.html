<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ahmed sapp</title>
  <style>
    :root {
      --bg: #111827; --panel: #0c1320; --muted: #9ca3af; --accent: #10b981;
      --bubble: #1f2937; --me: #059669; --glass: rgba(255, 255, 255, 0.05);
      --radius: 10px; --shadow: 0 4px 14px rgba(0, 0, 0, 0.5);
      font-family: 'Segoe UI', Roboto, 'Noto Kufi Arabic', Tahoma, sans-serif;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%; margin: 0; background: linear-gradient(180deg, var(--bg), #071021); color: #e6eef3;
    }
    .app {
      max-width: 1100px; margin: 20px auto; height: 86vh; display: grid;
      grid-template-columns: 320px 1fr; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow);
    }

    /* LEFT: contacts */
    .sidebar {
      background: linear-gradient(180deg, var(--panel), #071322); padding: 16px;
      display: flex; flex-direction: column; gap: 12px; transition: transform 0.28s ease-in-out;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 44px; height: 44px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--me));
      display: flex; align-items: center; justify-content: center; font-weight: 700;
    }
    .brand h1 { font-size: 16px; margin: 0; }
    .search { display: flex; gap: 8px; }
    .search input {
      flex: 1; padding: 10px; border-radius: var(--radius); border: 0;
      background: var(--glass); color: inherit;
    }
    .search button {
      padding: 10px; border-radius: var(--radius); border: 0;
      background: var(--accent); color: #012; cursor: pointer;
    }
    .contacts { overflow: auto; padding-right: 6px; -webkit-overflow-scrolling: touch; }
    .contact {
      display: flex; align-items: center; gap: 10px; padding: 10px;
      border-radius: var(--radius); cursor: pointer;
    }
    .contact:hover { background: rgba(255, 255, 255, 0.02); }
    .contact:focus { outline: 2px solid rgba(255,255,255,0.04); }

    .avatar {
      width: 44px; height: 44px; border-radius: 50%;
      background: linear-gradient(45deg, #334155, var(--me));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; flex-shrink: 0; position: relative;
    }
    .meta { flex: 1; overflow: hidden; }
    .meta .name { font-weight: 600; }
    .meta .last {
      color: var(--muted); font-size: 13px; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }

    /* RIGHT: chat */
    .chat {
      background: linear-gradient(180deg, #06121a, #071526);
      display: flex; flex-direction: column;
    }
    .chat-header {
      display: flex; align-items: center; gap: 12px; padding: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }
    .chat-main {
      flex: 1; overflow: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 12px;
    }
    .messages {
      display: flex; flex-direction: column; gap: 10px; max-width: 760px;
      width: 100%; margin-left: auto; margin-right: auto;
    }
    .bubble {
      padding: 10px 14px; border-radius: 14px; max-width: 70%;
      background: var(--bubble); box-shadow: 0 4px 12px rgba(2, 6, 23, 0.6);
      word-wrap: break-word;
    }
    .bubble.me {
      margin-left: auto; background: linear-gradient(135deg, var(--me), #047857); color: #fff;
    }
    .meta-time {
      font-size: 12px; color: var(--muted); margin-top: 6px;
    }
    .input-area {
      padding: 10px; border-top: 1px solid rgba(255, 255, 255, 0.03);
      display: flex; gap: 6px; align-items: center; background: rgba(0,0,0,0.12);
    }
    .input-area textarea {
      flex: 1; min-height: 44px; max-height: 140px; padding: 10px; border-radius: var(--radius);
      border: 0; background: var(--glass); resize: none; color: inherit; font-size: 15px;
    }
    .btn {
      padding: 10px 12px; border-radius: var(--radius); border: 0;
      background: var(--accent); color: #012; cursor: pointer; flex-shrink: 0;
    }
    .small { font-size: 13px; color: var(--muted); }
    .attachment-preview {
      display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap;
    }
    .thumb {
      width: 72px; height: 72px; border-radius: 8px; overflow: hidden;
      background: #0a1220; display: flex; align-items: center; justify-content: center;
    }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }

    .status { font-size: 13px; color: var(--muted); }
    .controls { display: flex; gap: 8px; }

    .toast {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px;
      background: #06202a; padding: 10px 14px; border-radius: 8px;
      color: var(--muted); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6); z-index: 100;
    }
    .online-indicator {
      position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px;
      background: #6b7280; border-radius: 50%; border: 2px solid var(--panel);
    }
    .online-indicator.active { background: var(--accent); }
    .status-ticks {
      font-size: 14px; font-weight: bold; color: var(--muted); display: inline-block; margin-right: 3px;
    }
    .status-ticks.delivered { color: var(--accent); }

    .empty-chat {
      margin: auto; text-align: center; color: var(--muted);
    }
    .empty-chat-icon { font-size: 48px; margin-bottom: 10px; }

    .msg-wrapper { display: flex; flex-direction: column; max-width: 100%; position: relative; }
    .msg-wrapper.me { align-items: flex-end; }
    .msg-wrapper.other { align-items: flex-start; }
    .delete-btn {
      position: absolute; left: -5px; top: 50%; transform: translateY(-50%);
      background: #dc2626; color: white; border: 0; border-radius: 50%;
      width: 28px; height: 28px; cursor: pointer; opacity: 0; transition: opacity 0.18s;
      font-size: 14px; line-height: 28px; padding: 0;
    }
    .msg-wrapper.me:hover .delete-btn { opacity: 1; }

    /* MOBILE VIEW */
    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr; height: 100vh; margin: 0; border-radius: 0;
      }
      .sidebar {
        position: fixed; top: 0; right: 0; width: 84%; height: 100%; z-index: 220;
        transform: translateX(100%); box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      }
      .sidebar.active { transform: translateX(0); }
      .chat { height: 100vh; border-radius: 0; display: flex; flex-direction: column; }
      .chat-header { position: relative; justify-content: space-between; padding-right: 12px; padding-left: 12px; }
      .toggle-menu {
        display: block; background: var(--accent); color: #012; border: 0; border-radius: 8px;
        padding: 6px 10px; cursor: pointer; font-weight: 700;
      }
      .contacts { padding-top: 8px; }
      .search input { font-size: 15px; padding: 10px; }
      .logo { width: 40px; height: 40px; }
      .avatar { width: 40px; height: 40px; font-size: 15px; }
      .contact { padding: 10px 8px; }
      .messages { padding-bottom: 8px; }
      .input-area { padding: 8px; gap: 8px; }
      .btn { padding: 10px; }
    }

    /* Hide menu button on desktop */
    @media (min-width: 901px) {
      .toggle-menu { display: none; }
    }

  </style>
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar" aria-label="ŸÇÿßÿ¶ŸÖÿ© ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ">
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <h1>ahmed sapp</h1>
        </div>
      </div>
      <div class="search">
        <input id="searchInput" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ÿ£Ÿà ÿ±ÿ≥ÿßŸÑÿ©" aria-label="ÿ®ÿ≠ÿ´">
        <button id="newChatBtn" title="ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©">+</button>
      </div>
      <div class="contacts" id="contactsList" aria-live="polite"></div>
    </aside>

    <main class="chat" aria-label="ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©">
      <header class="chat-header">
        <button class="toggle-menu" id="menuToggleBtn" aria-label="ŸÇÿßÿ¶ŸÖÿ©">‚ò∞</button>
        <div class="avatar" id="chatAvatar">ÿü</div>
        <div style="flex:1; min-width:0">
          <div id="chatName" style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">ÿßÿÆÿ™ÿ± ŸÖÿ≠ÿßÿØÿ´ÿ©</div>
          <div class="status" id="chatStatus">ÿßÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©</div>
        </div>
        <div class="controls">
          <button class="btn" id="exportBtn">ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ©</button>
          <button class="btn" id="clearBtn">ŸÖÿ≥ÿ≠</button>
        </div>
      </header>

      <section class="chat-main">
        <div class="messages" id="messages"></div>
      </section>

      <div class="input-area" role="region" aria-label="ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÉÿ™ÿßÿ®ÿ©">
        <input type="file" id="attachInput" accept="image/*" style="display:none">
        <button class="btn" id="attachBtn" title="ÿ•ÿ±ŸÅÿßŸÇ ÿµŸàÿ±ÿ©" aria-label="ÿ•ÿ±ŸÅÿßŸÇ ÿµŸàÿ±ÿ©">üìé</button>
        <textarea id="inputMsg" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." aria-label="ŸÜÿµ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©"></textarea>
        <button class="btn" id="sendBtn" aria-label="ÿ•ÿ±ÿ≥ÿßŸÑ">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
      </div>
      <div style="padding:0 16px 12px" id="attachPreviewContainer"></div>
    </main>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    'use strict';

    const STORAGE_KEY = 'ahmedChat-data-v1';
    const sampleContacts = [
      { id: 'c1', name: 'ÿ¥ÿ±ŸäŸÅ', bio: 'ÿµÿØŸäŸÇ ŸÇÿØŸäŸÖ', avatarText: 'ÿ¥', online: true },
      { id: 'c2', name: 'ÿ≥ÿßÿ±ÿ©', bio: 'ÿ≤ŸÖŸäŸÑÿ© ÿπŸÖŸÑ', avatarText: 'ÿ≥', online: false },
      { id: 'c3', name: 'ÿπŸÑŸä', bio: 'ÿ£ÿÆŸàŸäÿß', avatarText: 'ÿπ', online: true }
    ];

    let state = { contacts: [], conversations: {}, current: null, draft: '', attachments: [] };

    // ====== ÿ£ÿØŸàÿßÿ™ ŸÖÿ≥ÿßÿπÿØÿ© ======
    function nowTs() { return new Date().toISOString(); }
    function timeLabel(ts) {
      if (!ts) return '';
      try {
        const d = new Date(ts);
        return d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
      } catch (e) { return ''; }
    }
    function getStatusTicks(status) {
      if (status === 'delivered') return '<span class="status-ticks delivered">‚úì‚úì</span>';
      if (status === 'sent') return '<span class="status-ticks">‚úì</span>';
      return '';
    }
    function saveState() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
      catch (e) { console.error("Failed to save state:", e); }
    }
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          state = JSON.parse(raw);
          if (!state.attachments) state.attachments = [];
        } catch (e) { initDefault(); }
      } else { initDefault(); }
    }
    function initDefault() {
      state.contacts = sampleContacts;
      state.conversations = {
        c1: [{ id: 'm1', from: 'c1', text: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ! Ÿáÿ∞ÿß ÿ¥ÿßÿ™ ÿ£ÿ≠ŸÖÿØ :)', ts: nowTs(), status: 'delivered' }],
        c2: [], c3: []
      };
      state.current = null; state.attachments = [];
      saveState();
    }

    // ====== Ÿàÿßÿ¨Ÿáÿ© ======
    const contactsList = document.getElementById('contactsList');
    const messagesEl = document.getElementById('messages');
    const chatName = document.getElementById('chatName');
    const chatStatus = document.getElementById('chatStatus');
    const chatAvatar = document.getElementById('chatAvatar');
    const inputMsg = document.getElementById('inputMsg');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const attachInput = document.getElementById('attachInput');
    const attachPreviewContainer = document.getElementById('attachPreviewContainer');
    const searchInput = document.getElementById('searchInput');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const sidebar = document.querySelector('.sidebar');

    function renderContacts(filter = '') {
      contactsList.innerHTML = '';
      const filterLower = filter.toLowerCase();
      const items = state.contacts.filter(c => {
        const lastMsg = (state.conversations[c.id] || []).slice(-1)[0];
        const searchText = (c.name + ' ' + (lastMsg?.text || c.bio || '')).toLowerCase();
        return searchText.includes(filterLower);
      });
      items.forEach(c => {
        const lastMsg = (state.conversations[c.id] || []).slice(-1)[0];
        const el = document.createElement('div');
        el.className = 'contact';
        if (c.id === state.current) { el.style.background = 'rgba(255,255,255,0.05)'; }
        el.tabIndex = 0;
        el.innerHTML = `
          <div class="avatar">
            ${c.avatarText}
            <div class="online-indicator ${c.online ? 'active' : ''}"></div>
          </div>
          <div class="meta">
            <div class="name">${c.name}</div>
            <div class="last">${lastMsg ? (lastMsg.type === 'image' ? 'ÿµŸàÿ±ÿ©' : lastMsg.text) : c.bio}</div>
          </div>
        `;
        el.addEventListener('click', () => { openChat(c.id); });
        el.addEventListener('keydown', (e) => { if(e.key === 'Enter') openChat(c.id); });
        contactsList.appendChild(el);
      });
    }

    function scrollMessagesToBottom() {
      // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜÿ≤ŸàŸÑ ÿßŸÑÿØÿßŸÑÿ© ŸÑÿ£ÿÆÿ± ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿ∑ÿ±ŸäŸÇÿ© ŸÖŸàÿ´ŸàŸÇÿ©
      requestAnimationFrame(() => {
        const container = messagesEl.parentElement;
        if (container) container.scrollTop = container.scrollHeight;
      });
    }

    function renderChat() {
      messagesEl.innerHTML = '';
      if (!state.current) {
        chatName.textContent = 'ÿßÿÆÿ™ÿ± ŸÖÿ≠ÿßÿØÿ´ÿ©';
        chatStatus.textContent = 'ÿßÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©';
        chatAvatar.textContent = 'ÿü';
        messagesEl.innerHTML = `
          <div class="empty-chat">
            <div class="empty-chat-icon">üí¨</div>
            <p>ÿßÿÆÿ™ÿ± ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©<br>ŸÑÿ®ÿØÿ° ÿßŸÑÿØÿ±ÿØÿ¥ÿ©.</p>
          </div>
        `;
        return;
      }
      const contact = state.contacts.find(x => x.id === state.current);
      if (!contact) { state.current = null; renderChat(); return; }

      chatName.textContent = contact.name;
      if (!chatStatus.textContent.includes('...')) {
         chatStatus.textContent = contact.online ? 'ŸÖÿ™ÿµŸÑ' : 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
      }
      chatAvatar.textContent = contact.avatarText;

      const conv = state.conversations[state.current] || [];

      if (conv.length === 0) {
        messagesEl.innerHTML = `
          <div class="empty-chat">
            <div class="empty-chat-icon">üëã</div>
            <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ŸáŸÜÿß ÿ®ÿπÿØ.<br>ŸÇŸÑ ŸÖÿ±ÿ≠ÿ®ÿßŸã ŸÑŸÄ ${contact.name}!</p>
          </div>
        `;
      } else {
        conv.forEach(m => {
          const b = document.createElement('div');
          b.className = 'bubble ' + (m.from === 'me' ? 'me' : '');
          if (m.type === 'image') {
            b.innerHTML = `<div class="thumb"><img src="${m.src}" alt="attachment"></div>`;
            b.style.padding = '4px';
          } else {
            b.textContent = m.text;
          }
          const time = document.createElement('div');
          time.className = 'meta-time';
          const statusTicks = m.from === 'me' ? getStatusTicks(m.status) : '';
          time.innerHTML = timeLabel(m.ts) + statusTicks;

          const wrapper = document.createElement('div');
          wrapper.className = 'msg-wrapper ' + (m.from === 'me' ? 'me' : 'other');

          wrapper.appendChild(b);
          wrapper.appendChild(time);

          if (m.from === 'me') {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©';
            deleteBtn.dataset.messageId = m.id;
            deleteBtn.addEventListener('click', handleDeleteMessage);
            wrapper.appendChild(deleteBtn);
          }
          messagesEl.appendChild(wrapper);
        });
      }
      scrollMessagesToBottom();
      inputMsg.value = state.draft || '';
      renderAttachmentsPreview();
    }

    function handleDeleteMessage(event) {
      const btn = event.currentTarget;
      const messageId = btn.dataset.messageId;
      if (!messageId || !state.current) return;
      if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿü')) return;
      const conv = state.conversations[state.current];
      if (!conv) return;
      const messageIndex = conv.findIndex(m => m.id === messageId);
      if (messageIndex > -1) {
        conv.splice(messageIndex, 1);
        saveState();
        renderChat();
        renderContacts(searchInput.value);
        showToast('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©');
      } else {
        console.error('Message not found for deletion:', messageId);
      }
    }

    function openChat(id) {
      if (state.current) { state.draft = inputMsg.value; }
      state.current = id;
      state.draft = '';
      renderChat();
      renderContacts(searchInput.value);
      // ŸÑŸà ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑÿå ÿ£ÿ∫ŸÑŸÇ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ÿ®ÿπÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
      if (window.innerWidth <= 900 && sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
      }
    }

    function sendMessage() {
      if (!state.current) return showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ£ŸàŸÑÿßŸã');
      const text = inputMsg.value.trim();
      if (!text && state.attachments.length === 0) {
        return showToast('ÿ£ÿ∂ŸÅ ŸÜÿµ ÿ£Ÿà ŸÖÿ±ŸÅŸÇ ÿ£ŸàŸÑÿßŸã');
      }
      const conv = state.conversations[state.current] || (state.conversations[state.current] = []);

      state.attachments.forEach(att => {
        conv.push({ id: 'm' + Math.random().toString(36).slice(2, 9), from: 'me', type: 'image', src: att, ts: nowTs(), status: 'sent' });
      });
      if (text) {
        conv.push({ id: 'm' + Math.random().toString(36).slice(2, 9), from: 'me', text, ts: nowTs(), status: 'sent' });
      }

      inputMsg.value = ''; state.draft = ''; state.attachments = [];
      attachPreviewContainer.innerHTML = '';

      saveState();
      renderChat();
      renderContacts(searchInput.value);

      setTimeout(() => {
        const lastSent = conv.filter(m => m.from === 'me' && m.status === 'sent');
        lastSent.forEach(m => m.status = 'delivered');
        if (lastSent.length > 0) { saveState(); renderChat(); }
      }, 900);

      const contact = state.contacts.find(c => c.id === state.current);
      if (contact && contact.online) {
        // ŸÖÿ§ÿ¥ÿ± "ŸäŸÉÿ™ÿ® ÿßŸÑÿ¢ŸÜ"
        setTimeout(() => {
          if (state.current === contact.id) {
            chatStatus.textContent = '...ŸäŸÉÿ™ÿ® ÿßŸÑÿ¢ŸÜ ‚úçÔ∏è';
          }
        }, 1100);
        // ÿßŸÑÿ±ÿØ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        setTimeout(() => {
          if (state.current === contact.id) {
            const replyText = text ? `ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ±ÿ≥ÿßŸÑÿ™ŸÉ: "${text.slice(0, 40)}..."` : 'ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿµŸàÿ±ÿ©ÿå ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ!';
            const reply = {
              id: 'm' + Math.random().toString(36).slice(2, 9),
              from: contact.id, text: replyText, ts: nowTs(), status: ''
            };
            state.conversations[state.current].push(reply);
            saveState();
            renderChat();
            renderContacts(searchInput.value);
          }
        }, 1800);
      }
    }

    // ====== Attachments ======
    attachBtn.addEventListener('click', () => attachInput.click());
    attachInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      if (state.attachments.length > 0) {
        showToast('ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ŸÅÿßŸÇ ÿµŸàÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑ ÿ≠ÿßŸÑŸäÿßŸã'); return;
      }
      const reader = new FileReader();
      reader.onload = () => { state.attachments.push(reader.result); renderAttachmentsPreview(); };
      reader.readAsDataURL(f);
      attachInput.value = null;
    });
    function renderAttachmentsPreview() {
      attachPreviewContainer.innerHTML = '';
      if (state.attachments.length === 0) return;
      const wrap = document.createElement('div');
      wrap.className = 'attachment-preview';
      state.attachments.forEach((src, idx) => {
        const t = document.createElement('div'); t.className = 'thumb';
        t.innerHTML = `<img src="${src}" alt="preview ${idx}">`;
        wrap.appendChild(t);
      });
      const clearBtn = document.createElement('button');
      clearBtn.className = 'btn'; clearBtn.textContent = 'ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ±ŸÅŸÇÿßÿ™';
      clearBtn.style.background = '#b91c1c'; clearBtn.style.color = '#fff';
      clearBtn.addEventListener('click', () => {
        state.attachments = []; renderAttachmentsPreview();
      });
      attachPreviewContainer.appendChild(wrap);
      attachPreviewContainer.appendChild(clearBtn);
    }

    // ====== search, new chat, export, clear ======
    searchInput.addEventListener('input', (e) => renderContacts(e.target.value));
    document.getElementById('newChatBtn').addEventListener('click', () => {
      const name = prompt('ÿßÿ≥ŸÖ ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©:');
      if (!name) return;
      const id = 'c' + Math.random().toString(36).slice(2, 8);
      const item = { id, name, bio: 'ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ÿ¨ÿØŸäÿØÿ©', avatarText: name.trim()[0] || 'ÿü', online: false };
      state.contacts.unshift(item); state.conversations[item.id] = [];
      saveState(); renderContacts(); openChat(item.id);
    });
    document.getElementById('exportBtn').addEventListener('click', () => {
      try {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url;
        a.download = 'ahmed-chat-backup.json'; a.click();
        URL.revokeObjectURL(url); showToast('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
      } catch (e) { showToast('ŸÅÿ¥ŸÑ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ≥ÿÆÿ©'); }
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ÿü Ÿáÿ∞ÿß ÿ≥Ÿäÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ¥Ÿäÿ°!')) {
        localStorage.removeItem(STORAGE_KEY); initDefault();
        renderContacts(); renderChat(); showToast('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
      }
    });

    // ====== keyboard shortcuts and send ======
    sendBtn.addEventListener('click', sendMessage);
    inputMsg.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // autosize textarea ÿ®ÿ≥Ÿäÿ∑
    function autosizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }
    inputMsg.addEventListener('input', () => {
      autosizeTextarea(inputMsg);
    });
    setTimeout(() => autosizeTextarea(inputMsg), 500);

    function showToast(t) {
      const toast = document.getElementById('toast');
      toast.textContent = t; toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    // ====== Mobile sidebar toggle ======
    if (menuToggleBtn) {
      menuToggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });
    }
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨ŸäŸá (mobile)
    document.addEventListener('click', (e) => {
      if (window.innerWidth > 900) return;
      if (!sidebar.classList.contains('active')) return;
      const withinSidebar = e.composedPath().includes(sidebar);
      const withinButton = e.composedPath().includes(menuToggleBtn);
      if (!withinSidebar && !withinButton) sidebar.classList.remove('active');
    });

    // ====== init ======
    loadState(); renderContacts(); renderChat();
    window.ahmedChatState = state;

    // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿπŸÑŸâ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿ¨ŸÖ ÿßŸÑÿ¥ÿßÿ¥ÿ©
    window.addEventListener('resize', () => {
      if (window.innerWidth > 900) sidebar.classList.remove('active');
    });

  </script>
</body>
</html>
